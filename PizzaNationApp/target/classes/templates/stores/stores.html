<main>
    <div id="map" style="width:100%;height:500px"></div>
</main>

<th:block sec:authorize="isAnonymous() or hasAnyRole('ROLE_MODERATOR', 'ROLE_USER')">
    <script th:inline="javascript">
        function initMap() {
            let locations;
            /*<![CDATA[*/
            locations = /*[[${model}]]*/ null;
            /*]]>*/

            let myCenter = new google.maps.LatLng(42.6672542, 23.3519015);//hardcoded the center - SoftUni coordinates
            let mapCanvas = document.getElementById("map");
            let mapOptions = {center: myCenter, zoom: 17};
            let map = new google.maps.Map(mapCanvas, mapOptions);

            let iconBase = 'http://docs.google.com/uc?id=1utgYCBhVncxD5PRTkJUX2i5YHgws5OdL';

            for (let location of locations) {
                let myLatlng = new google.maps.LatLng(location.lat, location.lng);
                let marker = new google.maps.Marker({position: myLatlng, icon: iconBase});
                marker.setMap(map);

                addPopUpListener(marker, map);
            }
        }

        function addPopUpListener(marker, map) {
            google.maps.event.addListener(marker, 'click', function () {
                let infowindow = new google.maps.InfoWindow({
                    content: 'Pizza Nation Store, for more details please <a href="/contactUs">contact us via email or phone</a>.'
                });

                infowindow.open(map, marker);
            })
        }
    </script>
</th:block>
<th:block sec:authorize="hasRole('ROLE_ADMIN')">
    <script th:inline="javascript">
        function initMap() {
            let locations;
            /*<![CDATA[*/
            locations = /*[[${model}]]*/ null;
            /*]]>*/

            let myCenter = new google.maps.LatLng(42.6672542, 23.3519015);//hardcoded the center - SoftUni coordinates
            let mapCanvas = document.getElementById("map");
            let mapOptions = {center: myCenter, zoom: 17};
            let map = new google.maps.Map(mapCanvas, mapOptions);

            let iconBase = 'http://docs.google.com/uc?id=1utgYCBhVncxD5PRTkJUX2i5YHgws5OdL';

            for (let location of locations) {
                let myLatlng = new google.maps.LatLng(location.lat, location.lng);
                let marker = new google.maps.Marker({position: myLatlng, icon: iconBase});
                marker.setMap(map);

                addPopUpListener(marker, map);
                deletePopUpListener(marker, map);
            }

            addClickListener(map);
        }

        function placeMarker(location, map) {
            let iconBase = 'http://docs.google.com/uc?id=1utgYCBhVncxD5PRTkJUX2i5YHgws5OdL';

            let userMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: iconBase
            });

            addPopUpListener(userMarker, map);
        }

        function addPopUpListener(marker, map) {
            google.maps.event.addListener(marker, 'dblclick', function () {
                    let coordinates = {"lat": marker.getPosition().lat(), "lng": marker.getPosition().lng()};
                    let infowindow;

                    $.post("/admin/stores/add", coordinates)
                        .done(function () {
                            infowindow = new google.maps.InfoWindow({
                                content: 'Successfully added store.'
                            });

                            infowindow.open(map, marker);
                        })
                        .fail(function () {
                            infowindow = new google.maps.InfoWindow({
                                content: 'Failed to add store.'
                            });

                            infowindow.open(map, marker);
                        });
                }
            );
        }

        function deletePopUpListener(marker, map) {
            google.maps.event.addListener(marker, 'rightclick', function () {
                    let coordinates = {"lat": marker.getPosition().lat(), "lng": marker.getPosition().lng()};
                    let infowindow;

                    $.post("/admin/stores/delete", coordinates)
                        .done(function () {
                            infowindow = new google.maps.InfoWindow({
                                content: 'Successfully deleted store.'
                            });

                            infowindow.open(map, marker);
                        })
                        .fail(function () {
                            infowindow = new google.maps.InfoWindow({
                                content: 'Failed to delete store.'
                            });

                            infowindow.open(map, marker);
                        });

                    $.get("/reload")
                }
            );
        }

        function addClickListener(map) {
            google.maps.event.addListener(map, 'click', function (event) {
                placeMarker(event.latLng, map);
            });
        }

    </script>
</th:block>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCW_AEkfqP5zRCJmRmbqRx7giXRRlVWK6o&callback=initMap"></script>
